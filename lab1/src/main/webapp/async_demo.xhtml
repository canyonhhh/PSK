<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
<h:head>
   <title>Asynchronous Processing Demo</title>
   <h:outputStylesheet library="css" name="library-styles.css"/>
   <style type="text/css">
      .progress-container {
         border: 1px solid #ddd;
         padding: 15px;
         margin-top: 20px;
         border-radius: 5px;
         background-color: #f9f9f9;
         max-height: 300px;
         overflow-y: auto;
      }

      .progress-message {
         margin-bottom: 5px;
         padding: 5px;
         border-bottom: 1px solid #eee;
      }

      .result-container {
         margin-top: 20px;
         font-weight: bold;
      }
   </style>

   <!-- Auto-refresh for progress updates -->
   <script type="text/javascript">
      function startAutoRefresh() {
         intervalId = setInterval(function() {
            document.getElementById('progressForm:checkProgress').click();
         }, 1000); // Check every second
      }

      function stopAutoRefresh() {
         if (intervalId) {
            clearInterval(intervalId);
         }
      }

      var intervalId = null;
   </script>
</h:head>
<h:body>
   <h1>Asynchronous Processing Demo</h1>

   <p>This demonstration shows how to perform long-running calculations asynchronously in Jakarta EE.</p>

   <h:messages id="messages" globalOnly="true" styleClass="messages"
               errorClass="error" infoClass="info" />

   <h:form id="calculationForm">
      <div class="form-group">
         <h:outputLabel for="iterations" value="Number of iterations:" />
         <h:inputText id="iterations" value="#{asyncDemoController.iterations}" />
      </div>

      <div class="button-group">
         <h:commandButton value="Start Calculation" action="#{asyncDemoController.startCalculation()}"
                          disabled="#{asyncDemoController.calculationInProgress}"
                          onclick="startAutoRefresh()">
            <f:ajax execute="@form" render="@form :progressForm" />
         </h:commandButton>

         <h:commandButton value="Cancel" action="#{asyncDemoController.cancelCalculation()}"
                          disabled="#{!asyncDemoController.calculationInProgress}"
                          onclick="stopAutoRefresh()">
            <f:ajax execute="@this" render="@form :progressForm" />
         </h:commandButton>

         <h:commandButton value="Reset" action="#{asyncDemoController.reset()}"
                          onclick="stopAutoRefresh()">
            <f:ajax execute="@this" render="@form :progressForm :messages" />
         </h:commandButton>

         <h:button value="Back to Home" outcome="index" style="margin-left: 10px;" />
      </div>

      <div class="result-container">
         <h:outputText value="Result: #{asyncDemoController.result}"
                       rendered="#{asyncDemoController.result != null}" />
      </div>
   </h:form>

   <h:form id="progressForm">
      <h:commandButton id="checkProgress" value="Check Progress"
                       action="#{asyncDemoController.checkProgress()}" style="display: none;">
         <f:ajax execute="@this" render="@form :calculationForm :messages" />
      </h:commandButton>

      <div class="progress-container">
         <h2>Progress Log</h2>
         <ui:repeat value="#{asyncDemoController.progressMessages}" var="message">
            <div class="progress-message">#{message}</div>
         </ui:repeat>
      </div>
   </h:form>

   <script type="text/javascript">
      // If calculation is in progress when page loads, start the auto-refresh
      window.onload = function() {
         if (#{asyncDemoController.calculationInProgress}) {
            startAutoRefresh();
         }
      };
   </script>
</h:body>
</html>